#!/bin/bash

#
# packages/configs/package
#

DESCRIPTION='Symlinks the included dotfiles to their appropriate locations.'
INSTALL_MSG='Applying dotfiles...'
UNINSTALL_MSG='Restoring dotfiles...'

install() {
  declare -A links

  # Build up a list of symlinks to make
  for file in ${PACKAGE_FILES}/*; do
    if [[ "${file##*/}" == 'config' ]]; then
      for subfile in ${PACKAGE_FILES}/config/*; do
        links[${subfile}]=".config/${subfile##*/}"
      done
    elif [[ "${file##*/}" == 'local' ]]; then
      for subfile in ${PACKAGE_FILES}/local/share/applications/*; do
        links[${subfile}]=".local/share/applications/${subfile##*/}"
      done
    elif [[ "${file##*/}" == 'gnupg' ]]; then
      for subfile in ${PACKAGE_FILES}/gnupg/*; do
        links[${subfile}]=".gnupg/${subfile##*/}"
      done
    else
      links[${file}]=".${file##*/}"
    fi
  done

  # Create the symlinks in the appropriate places
  for src in "${!links[@]}"; do
    local dest="${HOME}/${links[$src]}"
    backup_and_link "${src}" "${dest}"
  done

  # Update .bashrc with correct dotfiles location if not set
  sed -i.bak "s,DOTFILES=.*,DOTFILES=\"${DOTFILES}\",g" "${PACKAGE_FILES}/bashrc" \
    && mv "${PACKAGE_FILES}/bashrc.bak" "${PACKAGE_FILES}/bashrc"
}

uninstall() {
  return
}

post_update() {
  source ~/.bashrc
}
